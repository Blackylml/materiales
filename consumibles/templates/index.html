{% extends 'base.html' %}

{% block content %}
<div class="card">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h4 class="mb-0">Recibos de Material</h4>
        <div>
            <button type="button" class="btn btn-primary me-2" id="btnNuevoRecibo">
                <i class="bi bi-plus-circle"></i> Nuevo Recibo
            </button>
            <button id="btnExportarExcel" class="btn btn-success me-2">
                <i class="bi bi-file-earmark-excel"></i> Exportar Todo
            </button>
            <button id="btnExportarSeleccionados" class="btn btn-success me-2" disabled>
                <i class="bi bi-file-earmark-excel"></i> Exportar Seleccionados
            </button>
           
            <button id="btnExportarReporte" class="btn btn-info" disabled>
                <i class="bi bi-file-earmark-text"></i> Generar Reporte FO-CC-03
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <form action="{{ url_for('index') }}" method="GET" class="row g-3">
                <div class="col-md-10">
                    <input type="text" name="filtro" class="form-control" placeholder="Buscar..." value="{{ filtro }}">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> Buscar
                    </button>
                </div>
            </form>
        </div>
        
        <div class="table-responsive">
            <table id="tablaRecibos" class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="seleccionarTodos">
                        </th>
                        <th>ID Code</th>
                        <th>Fecha</th>
                        <th>Orden de Compra</th>
                        <th>Proveedor</th>
                        <th>Remisión</th>
                        <th>Descripción</th>
                        <th>Cliente</th>
                        <th>Reporte FO-CC-03</th>
                        <th>Archivo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for recibo in recibos %}
                    <tr>
                        <td>
                            <input type="checkbox" class="seleccion-recibo" value="{{ recibo.id }}">
                        </td>
                        <td>{{ recibo.idcode or '' }}</td>
                        <td>{{ recibo.fecha.strftime('%d/%m/%Y') if recibo.fecha else '' }}</td>
                        <td>{{ recibo.orden_compra or '' }}</td>
                        <td>{{ recibo.proveedor or '' }}</td>
                        <td>{{ recibo.num_remision or '' }}</td>
                        <td>{{ recibo.descripcion_material or '' }}</td>
                        <td>{{ recibo.cliente or '' }}</td>
                        <td>{{ recibo.reporte_focc03 or '' }}</td>
                        <td>
                            {% if recibo.archivo %}
                            <a href="{{ url_for('descargar_archivo', id=recibo.id) }}" class="btn btn-sm btn-info">
                                <i class="bi bi-download"></i>
                            </a>
                            {% endif %}
                        </td>
                        <td class="table-actions">
                            <button type="button" class="btn btn-sm btn-primary ver-detalles" data-id="{{ recibo.id }}">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-warning editar-recibo" data-id="{{ recibo.id }}">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Nuevo/Editar Recibo -->
<div class="modal fade" id="modalNuevoRecibo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Nuevo Recibo de Material</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formRecibo" action="{{ url_for('guardar_recibo') }}" method="POST" enctype="multipart/form-data">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="idcode" class="form-label">ID Code</label>
                            <input type="text" class="form-control" id="idcode" name="idcode">
                        </div>
                        <div class="col-md-3">
                            <label for="fecha" class="form-label">Fecha</label>
                            <input type="date" class="form-control" id="fecha" name="fecha" value="{{ today }}">
                        </div>
                        <div class="col-md-3">
                            <label for="orden_compra" class="form-label">Orden de Compra</label>
                            <input type="text" class="form-control" id="orden_compra" name="orden_compra">
                        </div>
                        <div class="col-md-3">
                            <label for="proveedor" class="form-label">Proveedor</label>
                            <input type="text" class="form-control" id="proveedor" name="proveedor">
                        </div>
                    </div>
                    
                    <!-- El contenedor del selector de material se insertará aquí mediante JavaScript -->
                    
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="num_remision" class="form-label">Número de Remisión</label>
                            <input type="text" class="form-control" id="num_remision" name="num_remision">
                        </div>
                        <div class="col-md-3">
                            <label for="cantidad" class="form-label">Cantidad</label>
                            <input type="number" step="0.01" class="form-control" id="cantidad" name="cantidad">
                        </div>
                        <div class="col-md-3">
                            <label for="tipo" class="form-label">Tipo</label>
                            <input type="text" class="form-control" id="tipo" name="tipo">
                        </div>
                        <div class="col-md-3">
                            <label for="descripcion_material" class="form-label">Descripción del Material</label>
                            <input type="text" class="form-control" id="descripcion_material" name="descripcion_material">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="grado_acero" class="form-label">Grado de Acero</label>
                            <input type="text" class="form-control" id="grado_acero" name="grado_acero">
                        </div>
                        <div class="col-md-3">
                            <label for="num_placa" class="form-label">Número de Placa</label>
                            <input type="text" class="form-control" id="num_placa" name="num_placa">
                        </div>
                        <div class="col-md-3">
                            <label for="num_colada" class="form-label">Número de Colada</label>
                            <input type="text" class="form-control" id="num_colada" name="num_colada">
                        </div>
                        <div class="col-md-3">
                            <label for="num_certificado" class="form-label">Número de Certificado</label>
                            <input type="text" class="form-control" id="num_certificado" name="num_certificado">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="ot" class="form-label">OT</label>
                            <input type="text" class="form-control" id="ot" name="ot">
                        </div>
                        <div class="col-md-3">
                            <label for="cliente" class="form-label">Cliente</label>
                            <input type="text" class="form-control" id="cliente" name="cliente">
                        </div>
                        <div class="col-md-3">
                            <label for="estatus" class="form-label">Estatus</label>
                            <input type="text" class="form-control" id="estatus" name="estatus">
                        </div>
                        <div class="col-md-3">
                            <label for="reporte_focc03" class="form-label">Reporte FO-CC-03</label>
                            <input type="text" class="form-control" id="reporte_focc03" name="reporte_focc03">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="procedencia" class="form-label">Procedencia</label>
                            <select class="form-select" id="procedencia" name="procedencia">
                                <option value="">Seleccione una procedencia</option>
                                {% for p in procedencias %}
                                <option value="{{ p.id }}">{{ p.descripcion }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-9">
                            <label for="archivo" class="form-label">Archivo Adjunto</label>
                            <input type="file" class="form-control" id="archivo" name="archivo">
                        </div>
                    </div>
                    
                    <input type="hidden" name="accion" value="nuevo">
                    <input type="hidden" name="id" value="">
                    <input type="hidden" id="idordencompra" name="idordencompra">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarRecibo">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalles -->
<div class="modal fade" id="modalDetalles" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Detalles del Recibo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="contenidoDetalles">
                <!-- Aquí se cargará el contenido de los detalles -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Inicializar DataTable
        $('#tablaRecibos').DataTable({
            language: {
                url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json'
            },
            paging: true,
            ordering: true,
            info: true,
            searching: false,
            pageLength: 10
        });
        
        // Manejar el formulario de nuevo/editar recibo
        $('#btnGuardarRecibo').click(function() {
            $('#formRecibo').submit();
        });
        
        // Abrir modal para nuevo recibo
        $('#btnNuevoRecibo').click(function() {
            resetearFormulario();
            $('#modalNuevoRecibo').modal('show');
        });
        
        // Función para resetear formulario
        function resetearFormulario() {
            $('#formRecibo')[0].reset();
            $('#formRecibo input[name="id"]').val('');
            $('#formRecibo input[name="accion"]').val('nuevo');
            $('.modal-title').text('Nuevo Recibo de Material');
            $('#fecha').val('{{ today }}');
            $('#material_selector_container').hide();
        }
        
        // Abrir modal para editar
        $(document).on('click', '.editar-recibo', function() {
            const id = $(this).data('id');
            
            // Mostrar spinner o mensaje de carga
            Swal.fire({
                title: 'Cargando datos...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Cargar datos del recibo
            $.ajax({
                url: `/obtener_recibo/${id}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    Swal.close();
                    
                    if (data.status === 'success') {
                        const recibo = data.recibo;
                        
                        // Asignar valores a los campos
                        $('#formRecibo input[name="id"]').val(recibo.id);
                        $('#formRecibo input[name="accion"]').val('editar');
                        $('#idcode').val(recibo.idcode);
                        $('#fecha').val(recibo.fecha);
                        $('#orden_compra').val(recibo.orden_compra);
                        $('#proveedor').val(recibo.proveedor);
                        $('#num_remision').val(recibo.num_remision);
                        $('#cantidad').val(recibo.cantidad);
                        $('#tipo').val(recibo.tipo);
                        $('#descripcion_material').val(recibo.descripcion_material);
                        $('#grado_acero').val(recibo.grado_acero);
                        $('#num_placa').val(recibo.num_placa);
                        $('#num_colada').val(recibo.num_colada);
                        $('#num_certificado').val(recibo.num_certificado);
                        $('#ot').val(recibo.ot);
                        $('#cliente').val(recibo.cliente);
                        $('#estatus').val(recibo.estatus);
                        $('#reporte_focc03').val(recibo.reporte_focc03);
                        $('#procedencia').val(recibo.procedencia);
                        $('#idordencompra').val(recibo.idordencompra);
                        
                        // Ocultar el selector de materiales en modo edición
                        $('#material_selector_container').hide();
                        
                        // Cambiar título del modal
                        $('.modal-title').text('Editar Recibo de Material');
                        
                        // Mostrar el modal
                        $('#modalNuevoRecibo').modal('show');
                    } else {
                        Swal.fire('Error', 'No se pudo cargar el recibo', 'error');
                    }
                },
                error: function() {
                    Swal.close();
                    Swal.fire('Error', 'Ocurrió un error al cargar el recibo', 'error');
                }
            });
        });
        
        // Ver detalles
        $('.ver-detalles').click(function() {
            const id = $(this).data('id');
            $.ajax({
                url: `/detalles_recibo/${id}`,
                type: 'GET',
                success: function(data) {
                    $('#contenidoDetalles').html(data);
                    $('#modalDetalles').modal('show');
                },
                error: function() {
                    Swal.fire('Error', 'No se pudieron cargar los detalles', 'error');
                }
            });
        });
        
        // Manejo de selección de recibos
        $('#seleccionarTodos').change(function() {
            $('.seleccion-recibo').prop('checked', $(this).prop('checked'));
            actualizarBotonesSeleccion();
        });
        
        $(document).on('change', '.seleccion-recibo', function() {
            actualizarBotonesSeleccion();
        });
        
        function actualizarBotonesSeleccion() {
            const haySeleccionados = $('.seleccion-recibo:checked').length > 0;
            $('#btnExportarSeleccionados').prop('disabled', !haySeleccionados);
            $('#btnImportarSQL').prop('disabled', !haySeleccionados);
            
            // Verificar si hay recibos con el mismo valor en reporte_focc03
            const reportesSeleccionados = new Set();
            $('.seleccion-recibo:checked').each(function() {
                const reporte = $(this).closest('tr').find('td:eq(8)').text().trim();
                if (reporte) reportesSeleccionados.add(reporte);
            });
            
            $('#btnExportarReporte').prop('disabled', reportesSeleccionados.size !== 1);
        }
        
        // Exportar a Excel todos los registros
        $('#btnExportarExcel').click(function() {
            window.location.href = '{{ url_for("exportar_excel") }}?todos=1';
        });
        
        // Exportar a Excel seleccionados
        $('#btnExportarSeleccionados').click(function() {
            const ids = [];
            $('.seleccion-recibo:checked').each(function() {
                ids.push($(this).val());
            });
            
            if (ids.length > 0) {
                window.location.href = '{{ url_for("exportar_excel") }}?ids=' + ids.join(',');
            }
        });
        
        // Importar a SQL Server
        $('#btnImportarSQL').click(function() {
            const ids = [];
            $('.seleccion-recibo:checked').each(function() {
                ids.push($(this).val());
            });
            
            if (ids.length > 0) {
                Swal.fire({
                    title: '¿Confirmar importación?',
                    text: 'Se importarán los registros seleccionados a SQL Server',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, importar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '{{ url_for("importar_sqlserver") }}',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({ ids: ids }),
                            dataType: 'json',
                            success: function(response) {
                                let html = '';
                                if (response.logs && response.logs.length > 0) {
                                    html += '<div class="mt-3"><pre class="bg-dark text-white p-3" style="max-height: 300px; overflow-y: auto;">';
                                    response.logs.forEach(log => {
                                        html += log + '\n';
                                    });
                                    html += '</pre></div>';
                                }
                                
                                if (response.status === 'success') {
                                    Swal.fire({
                                        title: 'Éxito',
                                        html: response.message + html,
                                        icon: 'success'
                                    });
                                } else {
                                    Swal.fire({
                                        title: 'Error',
                                        html: response.message + html,
                                        icon: 'error'
                                    });
                                }
                            },
                            error: function() {
                                Swal.fire('Error', 'Ocurrió un error durante la importación', 'error');
                            }
                        });
                    }
                });
            }
        });
        
        // Generar Reporte FO-CC-03
        $('#btnExportarReporte').click(function() {
            const reporteId = $('.seleccion-recibo:checked').first().closest('tr').find('td:eq(8)').text().trim();
            
            if (reporteId) {
                window.location.href = '{{ url_for("exportar_reporte_focc03") }}?reporte=' + encodeURIComponent(reporteId);
            }
        });
        
        // Agregar contenedor para selector de materiales si no existe
        if (!$('#material_selector_container').length) {
            const selectorHtml = `
                <div id="material_selector_container" class="row mb-3" style="display: none;">
                    <div class="col-md-12">
                        <label for="material_selector" class="form-label">Seleccione Material</label>
                        <select class="form-select" id="material_selector">
                            <option value="">Seleccione un material</option>
                        </select>
                    </div>
                </div>
            `;
            
            // Insertar después de la fila que contiene orden_compra
            $(selectorHtml).insertAfter($('#orden_compra').closest('.row'));
        }
        
        // Eliminar eventos existentes para evitar duplicados
        $('#orden_compra').off('change');
        $(document).off('change', '#material_selector');
        
        // Asociar eventos una sola vez
        $('#orden_compra').on('change', cargarArticulosPorOrdenCompra);
        $(document).on('change', '#material_selector', seleccionarMaterial);
    });
    
    // Función para cargar artículos al cambiar el número de orden de compra
    function cargarArticulosPorOrdenCompra() {
        const ordenCompra = $('#orden_compra').val().trim();
        
        // Limpiar el selector de materiales
        $('#material_selector').empty().append('<option value="">Seleccione un material</option>');
        
        if (!ordenCompra) {
            return;
        }
        
        // Mostrar indicador de carga
        Swal.fire({
            title: 'Cargando materiales...',
            text: 'Buscando materiales de la orden de compra',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        // Realizar la solicitud AJAX
        $.ajax({
            url: `/buscar_articulos_por_oc/${ordenCompra}`,
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                Swal.close();
                
                if (response.status === 'success') {
                    const articulos = response.articulos;
                    
                    if (articulos.length === 0) {
                        Swal.fire('Información', 'La orden de compra no tiene artículos asociados', 'info');
                        return;
                    }
                    
                    // Si hay un solo artículo, llenar directamente los campos
                    if (articulos.length === 1) {
                        $('#descripcion_material').val(articulos[0].descripcion);
                        $('#cantidad').val(articulos[0].unidades);
                        $('#proveedor').val(articulos[0].proveedor);
                        // Guardar el ID de orden de compra
                        $('#idordencompra').val(response.docto_cm_id);
                        return;
                    }
                    
                    // Si hay más de un artículo, mostrar selector
                    $('#material_selector_container').show();
                    
                    // Llenar el selector de materiales
                    articulos.forEach(function(articulo) {
                        $('#material_selector').append(
                            `<option value="${articulo.articulo_id}" 
                             data-descripcion="${articulo.descripcion}"
                             data-unidades="${articulo.unidades}"
                             data-proveedor="${articulo.proveedor}">
                             ${articulo.descripcion} (${articulo.unidades} unidades)
                             </option>`
                        );
                    });
                    
                    // Almacenar el ID de documento para uso posterior
                    $('#idordencompra').val(response.docto_cm_id);
                    
                    // Notificar al usuario
                    Swal.fire('Éxito', 'Seleccione un material de la lista', 'success');
                } else {
                    Swal.fire('Error', response.message, 'error');
                }
            },
            error: function(xhr, status, error) {
                Swal.close();
                Swal.fire('Error', 'Ocurrió un error al cargar los materiales', 'error');
                console.error(error);
            }
        });
    }
    
    // Función para manejar la selección de material
    function seleccionarMaterial() {
        const optionSelected = $('#material_selector option:selected');
        
        if (optionSelected.val()) {
            // Llenar campos con datos del material seleccionado
            $('#descripcion_material').val(optionSelected.data('descripcion'));
            $('#cantidad').val(optionSelected.data('unidades'));
            $('#proveedor').val(optionSelected.data('proveedor'));
        } else {
            // Limpiar campos si no hay selección
            $('#descripcion_material').val('');
            $('#cantidad').val('');
        }
    }
</script>
{% endblock %}